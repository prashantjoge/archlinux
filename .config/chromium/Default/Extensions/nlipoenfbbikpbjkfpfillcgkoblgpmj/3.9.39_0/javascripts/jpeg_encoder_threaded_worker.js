function JPEGEncoder(e){var m,I,A,S,C=this,h=(Math.round,Math.floor),s=new Array(64),u=new Array(64),M=new Array(64),E=new Array(64),p=new Array(65535),w=new Array(65535),Y=new Array(64),_=[],J=0,j=7,l=new Array(64),N=new Array(64),b=new Array(64),k=new Array(64),r=new Array(256),x=[],O=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],f=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],i=[0,1,2,3,4,5,6,7,8,9,10,11],v=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],g=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],y=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],Q=[0,1,2,3,4,5,6,7,8,9,10,11],q=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],G=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function a(e,a){for(var r=0,n=0,o=new Array,t=1;t<=16;t++){for(var c=1;c<=e[t];c++)o[a[n]]=[],o[a[n]][0]=r,o[a[n]][1]=t,n++,r++;r*=2}return o}function P(e){for(var a=e[0],r=e[1]-1;0<=r;)a&1<<r&&(J|=1<<j),r--,--j<0&&(255==J?(z(255),z(0)):z(J),j=7,J=0)}function z(e){_.push(r[e])}function B(e){z(e>>8&255),z(255&e)}function D(e,a,r,n,o){for(var t,c=o[0],d=o[240],f=function(e,a){var r,n,o,t,c,d,f,i,v,h,s=0;for(v=0;v<8;++v){r=e[s],n=e[s+1],o=e[s+2],t=e[s+3],c=e[s+4],d=e[s+5],f=e[s+6];var u=r+(i=e[s+7]),x=r-i,g=n+f,y=n-f,p=o+d,w=o-d,l=t+c,m=t-c,I=u+l,A=u-l,S=g+p,C=g-p;e[s]=I+S,e[s+4]=I-S;var M=.707106781*(C+A);e[s+2]=A+M,e[s+6]=A-M;var E=.382683433*((I=m+w)-(C=y+x)),_=.5411961*I+E,J=1.306562965*C+E,j=.707106781*(S=w+y),N=x+j,b=x-j;e[s+5]=b+_,e[s+3]=b-_,e[s+1]=N+J,e[s+7]=N-J,s+=8}for(v=s=0;v<8;++v){r=e[s],n=e[s+8],o=e[s+16],t=e[s+24],c=e[s+32],d=e[s+40],f=e[s+48];var k=r+(i=e[s+56]),O=r-i,Q=n+f,q=n-f,G=o+d,P=o-d,z=t+c,B=t-c,D=k+z,F=k-z,H=Q+G,K=Q-G;e[s]=D+H,e[s+32]=D-H;var L=.707106781*(K+F);e[s+16]=F+L,e[s+48]=F-L;var R=.382683433*((D=B+P)-(K=q+O)),T=.5411961*D+R,U=1.306562965*K+R,V=.707106781*(H=P+q),W=O+V,X=O-V;e[s+40]=X+T,e[s+24]=X-T,e[s+8]=W+U,e[s+56]=W-U,s++}for(v=0;v<64;++v)h=e[v]*a[v],Y[v]=0<h?h+.5|0:h-.5|0;return Y}(e,a),i=0;i<64;++i)l[O[i]]=f[i];var v=l[0]-r;r=l[0],0==v?P(n[0]):(P(n[w[t=32767+v]]),P(p[t]));for(var h=63;0<h&&0==l[h];h--);if(0==h)return P(c),r;for(var s,u=1;u<=h;){for(var x=u;0==l[u]&&u<=h;++u);var g=u-x;if(16<=g){s=g>>4;for(var y=1;y<=s;++y)P(d);g&=15}t=32767+l[u],P(o[(g<<4)+w[t]]),P(p[t]),u++}return 63!=h&&P(c),r}function F(e,a){var r,n;_=new Array,J=0,j=7,B(65496),B(65504),B(16),z(74),z(70),z(73),z(70),z(0),z(1),z(1),z(0),B(1),B(1),z(0),z(0),function(){B(65499),B(132),z(0);for(var e=0;e<64;e++)z(s[e]);z(1);for(var a=0;a<64;a++)z(u[a])}(),r=e,n=a,B(65472),B(17),z(8),B(n),B(r),z(3),z(1),z(17),z(0),z(2),z(17),z(1),z(3),z(17),z(1),function(){B(65476),B(418),z(0);for(var e=0;e<16;e++)z(f[e+1]);for(var a=0;a<=11;a++)z(i[a]);z(16);for(var r=0;r<16;r++)z(v[r+1]);for(var n=0;n<=161;n++)z(g[n]);z(1);for(var o=0;o<16;o++)z(y[o+1]);for(var t=0;t<=11;t++)z(Q[t]);z(17);for(var c=0;c<16;c++)z(q[c+1]);for(var d=0;d<=161;d++)z(G[d])}(),B(65498),B(12),z(3),z(1),z(0),z(2),z(17),z(3),z(17),z(0),z(63),z(0)}this.encode=function(e,a){this.encode.displayName="_encode_",a&&C.setQuality(a),F(e.width,e.height);var r=0,n=0,o=0;J=0,j=7;for(var t,c,d,f,i,v,h,s,u,x=e.data,g=e.width,y=e.height,p=3*g,w=0;w<y;){for(t=0;t<p;){for(v=i=p*w+t,h=-1,u=s=0;u<64;u++)v=i+(s=u>>3)*p+(h=3*(7&u)),y<=w+s&&(v-=p*(w+1+s-y)),p<=t+h&&(v-=t+h-p+3),c=x[v++],d=x[v++],f=x[v++],N[u]=(H[c]+H[d+256>>0]+H[f+512>>0]>>16)-128,b[u]=(H[c+768>>0]+H[d+1024>>0]+H[f+1280>>0]>>16)-128,k[u]=(H[c+1280>>0]+H[d+1536>>0]+H[f+1792>>0]>>16)-128;r=D(N,M,r,m,A),n=D(b,E,n,I,S),o=D(k,E,o,I,S),t+=24}w+=8}if(0<=j){var l=[];l[1]=j+1,l[0]=(1<<j+1)-1,P(l)}B(65497),postMessage(_.join(""))};var H=new Array(2048);this.setQuality=function(e){e||(e=50),e<=0&&(e=1),100<e&&(e=100);var a=0;a=e<50?Math.floor(5e3/e):Math.floor(200-2*e),x[a]?(s=x[a][0],u=x[a][1],M=x[a][2],E=x[a][3]):function(e){for(var a=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],r=0;r<64;r++){var n=h((a[r]*e+50)/100);n<1?n=1:255<n&&(n=255),s[O[r]]=n}for(var o=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],t=0;t<64;t++){var c=h((o[t]*e+50)/100);c<1?c=1:255<c&&(c=255),u[O[t]]=c}for(var d=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],f=0,i=0;i<8;i++)for(var v=0;v<8;v++)M[f]=1/(s[O[f]]*d[i]*d[v]*8),E[f]=1/(u[O[f]]*d[i]*d[v]*8),f++;x[e]=[s.slice(),u.slice(),M.slice(),E.slice()]}(a)},this.clearCaches=function(){x=[]},function(){for(var e=String.fromCharCode,a=0;a<256;a++)r[a]=e(a)}(),m=a(f,i),I=a(y,Q),A=a(v,g),S=a(q,G),function(){for(var e=1,a=2,r=1;r<=15;r++){for(var n=e;n<a;n++)w[32767+n]=r,p[32767+n]=[],p[32767+n][1]=r,p[32767+n][0]=n;for(var o=-(a-1);o<=-e;o++)w[32767+o]=r,p[32767+o]=[],p[32767+o][1]=r,p[32767+o][0]=a-1+o;e<<=1,a<<=1}}(),function(){for(var e=0;e<256;e++)H[e]=19595*e,H[e+256>>0]=38470*e,H[e+512>>0]=7471*e+32768,H[e+768>>0]=-11059*e,H[e+1024>>0]=-21709*e,H[e+1280>>0]=32768*e+8421375,H[e+1536>>0]=-27439*e,H[e+1792>>0]=-5329*e}(),C.setQuality(e)}var encoder=new JPEGEncoder,imageCache=[],metaStorage=[],expectMode="json",expectedIndex=0,doEncode=!0;function clearCaches(){imageCache=[],metaStorage=[],encoder.clearCaches()}function prepareImage(e,a,r){for(var n=e.length,o=new Array(n),t=0;t<n;t++)o[t]=e.charCodeAt(t);return{data:o,width:a,height:r}}onmessage=function(e){if("json"==expectMode){var a=JSON.parse(e.data);switch(a.command){case"encode_new":doEncode=!0,expectMode="imgString",metaStorage[a.data.cacheIndex]=a.data,expectedIndex=a.data.cacheIndex;break;case"cache_only":doEncode=!1,expectMode="imgString",metaStorage[a.data.cacheIndex]=a.data,expectedIndex=a.data.cacheIndex;break;case"encode_cached":doEncode=!0,postMessage(JSON.stringify({cacheIndex:a.data.cacheIndex})),encoder.encode(imageCache[a.data.cacheIndex],a.data.quality);break;case"clear_caches":clearCaches()}}else imageCache[expectedIndex]=prepareImage(e.data,metaStorage[expectedIndex].width,metaStorage[expectedIndex].height),doEncode&&(postMessage(JSON.stringify({cacheIndex:expectedIndex})),encoder.encode(imageCache[expectedIndex],metaStorage[expectedIndex].quality)),expectMode="json"};