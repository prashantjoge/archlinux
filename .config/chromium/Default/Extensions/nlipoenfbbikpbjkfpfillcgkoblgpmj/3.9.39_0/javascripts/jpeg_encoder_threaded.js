function JPEGEncoderThreaded(e){var c,l=new Worker(e||"jpeg_encoder_threaded_worker.js"),m=0,f=[],w=this,n="json",i=0,I=function(){for(var e=String.fromCharCode,a=new Array(256),t=0;t<256;t++)a[t]=e(t);return a}();function r(e,a,t,n,c){var i=new _(w,m,a,t,n);f[m]=i,m++;var r=c?"cache_only":"encode_new";l.postMessage(JSON.stringify({command:r,data:{cacheIndex:i._cachedImageIndex,quality:i.quality,cache:i._cache,width:e.width,height:e.height}}));for(var h=e.data,d=h.length,o=new Array(d/4*3),s=0,g=0;g<d;g+=4)o[s++]=I[h[g]],o[s++]=I[h[g+1]],o[s++]=I[h[g+2]];var u=o.join("");return o=null,l.postMessage(u),u=null,!n||i}function _(a,e,t,n,c){a=a;this._cachedImageIndex=e,this._cache=c,this.quality=t,this.callback=n,this.encode=function(e){e&&(this.quality=e),a._encodeCached(this._cachedImageIndex,this.quality,this.callback)}}l.onmessage=function(e){var a;if("json"==n)a=JSON.parse(e.data),i=a.cacheIndex,n="datauri";else{a=f[i];var t=(new Date).getTime()-c;console.log("Threaded encoding time: "+t+"ms"),a.callback("data:image/jpeg;base64,"+btoa(e.data)),a._cache||(f[i]=null),n="json"}},this.encode=function(e,a,t,n){return c=(new Date).getTime(),r(e,a,t,n,!1)},this.prepareImage=function(e,a,t){return r(e,a,t,!0,!0)},this._encodeCached=function(e,a,t){c=(new Date).getTime(),l.postMessage(JSON.stringify({command:"encode_cached",data:{cacheIndex:e,quality:a}}))},this.clearCaches=function(){m=0,f=[],l.postMessage(JSON.stringify({command:"clear_caches"}))}}function getImageDataFromImage(e){var a="string"==typeof e?document.getElementById(e):e,t=document.createElement("canvas");t.width=a.width,t.height=a.height;var n=t.getContext("2d");return n.drawImage(a,0,0),n.getImageData(0,0,t.width,t.height)}