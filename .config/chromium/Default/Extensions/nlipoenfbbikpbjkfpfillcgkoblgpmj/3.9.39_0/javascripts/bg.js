var win,menuType,type,tabid,taburl,tabtitle,counter,ratio,scrollBar,data,tempDataUrl,currentWindowId,currentTabId,D_T,dataURL=[],centerW=0,centerH=0,currentversion=chrome.app.getDetails().version,tabids={},centerOffX=0,centerOffY=0;function enablePriceCompare(){localStorage.pcnotification="true",localStorage.popupnotification="true",localStorage.barnotification="true",localStorage.show_feature_bar="false",refreshOptions()}function disablePriceCompare(){localStorage.pcnotification="false",localStorage.popupnotification="false",localStorage.barnotification="false","never"!==localStorage.show_feature_bar&&(localStorage.show_feature_bar="true"),refreshOptions()}function captureVisible(){type="visible",getSelectedTab(function(){chrome.windows.update(currentWindowId,{focused:!0},function(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){dataURL.push(e),newTab()})})})})}function captureSelected(){type="selected",getSelectedTab(checkContentScript)}function captureEntire(){type="entire",getSelectedTab(checkContentScript)}function getSelectedTab(t){chrome.tabs.getSelected(null,function(e){tabid=e.id,taburl=e.url,tabtitle=e.title,null!=t&&t()})}function checkContentScript(){chrome.tabs.executeScript(tabid,{file:"javascripts/isload.js"})}function saveAndScroll(){pushDataURL()}function pushDataURL(){chrome.windows.update(currentWindowId,{focused:!0},function(){chrome.tabs.update(currentTabId,{active:!0},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){dataURL.push(e),sendRequest("tab",tabid,{action:"scroll_next"})})})})}function updateShortcutsRequest(e){sendRequest("tab",e,{action:"update_shortcuts",msObj:localStorage.msObj})}function newTab(a){if(console.log(dataURL instanceof String,dataURL,menuType),dataURL)if("selected"==menuType&&sendRequest("tab",tabid,{action:"destroy_selected"}),"true"==localStorage.autoSave)prepareImage();else{if(a&&"gmail"==a.type)var o="edit.html?"+a.type+"="+a.tabId;else o="edit.html";chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(a&&a.tabId)var t=e[0].index;else t=e[0].index+1;chrome.tabs.create({url:o,index:t},function(e){console.log(tabid+"+"+e.id),tabids[e.id]=tabid,tabid=e.id})})}else alert("Screen Capture Fail!!")}function prepareImage(){var _,k,R=document.getElementById("tempCanvas"),T=R.getContext("2d"),r=document.getElementById("test_image"),c=(document.getElementById("temp_image"),17),i=function(){if(_=r.width,k=r.height,console.log(menuType),"visible"==type){var d,e;console.log(centerW,centerH,r.width,r.height),S="selected"==menuType?(d=centerW*window.devicePixelRatio,e=centerH*window.devicePixelRatio,h=centerOffX,centerOffY):(d=r.width,e=r.height,h=0),$("#tempCanvas").attr({width:d,height:e}),T.drawImage(r,h*window.devicePixelRatio,S*window.devicePixelRatio,d,e,0,0,d,e),"jpg"==localStorage.format?tempDataUrl=R.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=R.toDataURL());var t=document.getElementById("pluginobj");console.log(tempDataUrl,tabtitle),t.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout(function(){chrome.tabs.getSelected(function(e){chrome.tabs.sendRequest(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),chrome.extension.sendRequest({action:"closeWin"})},1e3)}else if("entire"==type||"selected"==type){var u=dataURL;console.log("enter entire",u.length,counter,k,_);var p=j=n=0,a=u.length,b=counter,g=Math.round(a/b);function m(e,t,a,o,r,c,i,l,s){i=p*k,p==g-1&&(a=k-lastH,r=s=lastH),console.log(p,n,g-1),$("#temp_image").attr({src:e}).load(function(){$(this).unbind("load"),T.drawImage(this,t,a,o,r,c,i,l,s),++p>g-1?(console.log("nextCol"),function(){if(++j>b-1){var e=document.getElementById("pluginobj");return"jpg"==localStorage.format?tempDataUrl=R.toDataURL("image/jpeg"):"png"==localStorage.format&&(tempDataUrl=R.toDataURL()),console.log("final",tempDataUrl),e.AutoSave(tempDataUrl,tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),localStorage.savePath),setTimeout(function(){chrome.tabs.getSelected(function(e){chrome.tabs.sendRequest(e.id,{action:"finishAutoSave",path:localStorage.savePath})}),chrome.extension.sendRequest({action:"closeWin"})},1e3)}w=(f=j==b-1?(h=_-lastW,dw=d-j*_):(h=0,dw=_),j*_);S=0,v=dh=k,p=y=0,n=p+j*g,m(u[n],h,S,f,v,w,y,dw,dh)}()):(console.log("PrepareV"),m(u[++n],t,a,o,r,c,i,l,s))})}function o(){$(R).attr({width:d,height:e})}if(!scrollBar.x&&scrollBar.y){_-=c,g=a,lastH=k*ratio.y,d="selected"==menuType?(scrollBar.realX&&(k-=c),centerW*window.devicePixelRatio):_,e=lastH?k*(g-1)+lastH:k*g,o();var h=0,f=dw=_,w=0,S=0,v=dh=k,y=0;m(u[n],h,S,f,v,w,y,dw,dh)}if(scrollBar.x&&!scrollBar.y){k-=c,b=a,lastW=_*ratio.x,e="selected"==menuType?(scrollBar.realY&&(_-=c),centerH*window.devicePixelRatio):k,d=lastW?_*(b-1)+lastW:_*b,o();h=0,f=dw=_,w=0,S=0,v=dh=k,y=0;!function e(t,a,o,r,n,c,i,l,s,d){c=j*_,j==b-1&&(a=_-lastW,r=l=lastW),$("#temp_image").attr({src:t}).load(function(){$(this).unbind("load"),T.drawImage(this,a,o,r,n,c,i,l,s),j<b-1&&e(u[++j],a,o,r,n,c,i,l,s)})}(u[n],h,S,f,v,w,y,dw,dh)}if(scrollBar.x&&scrollBar.y){lastW=_*ratio.x,lastH=k*ratio.y,_-=c,k-=c,e="selected"==menuType?(d=centerW*window.devicePixelRatio,centerH*window.devicePixelRatio):(d=lastW?_*(b-1)+lastW:_*b,lastH?k*(g-1)+lastH:k*g),o();h=0,f=dw=_,w=0,S=0,v=dh=k,y=0;m(u[n],h,S,f,v,w,y,dw,dh)}}dataURL=[],r.removeEventListener("onload",i,!1),r.src=""};r.onload=i,r.src=dataURL[0]}function sendRequest(e,t,a){switch(e){case"tab":chrome.tabs.sendRequest(t,a);break;case"popup":chrome.extension.sendRequest(a)}}localStorage.msObj||(localStorage.msObj='{"visible":{"enable":true,"key":"V"},"selected":{"enable":true,"key":"S"},"entire":{"enable":true,"key":"E"}}'),localStorage.format||(localStorage.format="png"),localStorage.delay_sec||(localStorage.delay_sec=3),localStorage["data-tracking"]||(localStorage["data-tracking"]=!0),localStorage.aws_s&&32!==localStorage.aws_s.length&&(localStorage.aws_s="",localStorage.aws_uid="",localStorage.aws_username=""),localStorage["show-noti"]||(localStorage["show-noti"]=!0),localStorage.record_mic||(localStorage.record_mic=!0),localStorage.record_countdown||(localStorage.record_countdown=3),localStorage.reocrd_type||(localStorage.record_type="tab"),localStorage["gmail-btn"]||(localStorage["gmail-btn"]="true"),D_T="true"==localStorage["data-tracking"],$(document).ready(function(){}),localStorage.autoSave="false",chrome.extension.onRequest.addListener(function(e,t,a){switch(console.log(t.tab),chrome.tabs.getSelected(null,function(e){currentWindowId=e.windowId,currentTabId=e.id}),console.log(e.action,menuType,t),t.tab&&-1!=t.tab.id&&"visible"!=e.action&&"selected"!=e.action&&"entire"!=e.action||(menuType=e.action,e.menuType&&(menuType=e.menuType)),e.action){case"visible":"selected"==menuType&&(type="visible",centerW=e.centerW,centerH=e.centerH),captureVisible(),sendRequest("tab",tabid,{action:"restorebar"});break;case"selected":captureSelected();break;case"entire":captureEntire();break;case"https":alert("For security reason, Capture Selected Area doesn't work in https pages! Please try other options.");case"insert_script":"selected"==menuType&&(chrome.tabs.executeScript(tabid,{file:"javascripts/dragresize.js"}),chrome.tabs.insertCSS(tabid,{file:"stylesheets/selected.css"}),console.log("insert")),chrome.tabs.executeScript(tabid,{file:"javascripts/content_script.js"},function(){sendRequest("tab",tabid,{action:"init_"+menuType+"_capture"})});break;case"script_running":sendRequest("tab",tabid,{action:"init_"+type+"_capture"});break;case"check_shortcuts":updateShortcutsRequest(t.tab.id);break;case"update_shortcuts":chrome.tabs.getAllInWindow(null,function(e){for(var t=0,a=e.length;t<a;t++){var o=e[t],r=o.url;r.match(/https?:\/\/*\/*/gi)&&!r.match(/https:\/\/chrome.google.com\/extensions/i)&&updateShortcutsRequest(o.id)}});break;case"scroll_next_done":saveAndScroll();break;case"entire_capture_done":counter=e.counter,ratio=e.ratio,scrollBar=e.scrollBar,type="entire","selected"==menuType&&(centerW=e.centerW,centerH=e.centerH),console.log("newTab"),sendRequest("tab",tabid,{action:"restorebar"}),newTab();break;case"capture_selected_done":type="visible",centerH=e.data.h,centerW=e.data.w,centerOffX=e.data.x,centerOffY=e.data.y,captureVisible();break;case"ready":return console.log(77,menuType,tabid,taburl),sendRequest("tab",tabid,{menuType:menuType,type:type,data:dataURL,taburl:taburl,tabtitle:tabtitle,counter:counter,ratio:ratio,scrollBar:scrollBar,centerW:centerW,centerH:centerH,centerOffX:centerOffX,centerOffY:centerOffY}),void(dataURL=[]);case"copy":chrome.experimental.clipboard.executeCopy(tabid,function(){alert("copied")});break;case"exit":chrome.tabs.getSelected(null,function(e){chrome.tabs.remove(e.id)});break;case"get_option":a({options:localStorage.msObj});break;case"newtip":if(!localStorage.version||localStorage.version!=currentversion){chrome.browserAction.setBadgeText({text:""}),count=1,window.open("https://www.diigo.com/awe/new-for-awesome-screenshot.html?v="+currentversion),localStorage.version=currentversion,chrome.extension.sendRequest({action:"shownew"})}break;case"openNewTab":var o=e.url;chrome.tabs.create({url:o});break;case"openOauthTab":o=e.url;chrome.tabs.create({url:o}),chrome.tabs.remove(t.tab.id);break;case"enablePriceCompare":console.log("enable"),enablePriceCompare(),localStorage.show_feature_bar="false";break;case"getShowFeatureBar":a(localStorage.show_feature_bar);break;case"disableShowFeatureBar":localStorage.show_feature_bar="never";break;case"desktop":e.type&&"gmail"==e.type?beginDesktop(t.tab.id):beginDesktop();break;case"record":beginRecord(e.options);break;case"gmail-btn":a("true"==localStorage["gmail-btn"])}}),chrome.tabs.onUpdated.addListener(function(e,t,a){console.log("test:",t.url,"http://www.awesomescreenshot.com/redirect.html#"==t.url),"chrome-extension://alelhddbbhepgpmgidjdcjakblofbmce/#"==t.url?chrome.extension.sendRequest({name:"loginByGoogle"}):"https://www.awesomescreenshot.com/redirect.html"!=t.url&&"https://www.awesomescreenshot.com/redirect.html#"!=t.url||(chrome.extension.sendRequest({name:"awsLoginByGoogle"}),chrome.tabs.remove(a.id)),chrome.tabs.sendRequest(e,{action:"tabupdate"})}),chrome.tabs.onRemoved.addListener(function(e){tabids[e]&&chrome.tabs.update(tabids[e],{selected:!0})}),localStorage.version&&"3.9.31"!=localStorage.newClickVersion&&chrome.browserAction.setBadgeText({text:"New"});var baseUrl="https://www.awesomescreenshot.com";function onLicenseUpdate(e){var t=e.response.details;console.log("onLicenseUpdate",t);var a=t.length;function o(){if(0<a){for(var e=0;e<a;e++)if("capture_desktop_window"===t[e].sku)return!0;return!1}return!1}console.log(o()),o()?localStorage.capture_desktop="true":localStorage.capture_desktop="false"}function onLicenseUpdateFail(e){console.log("onSkuDetailsFailed",e)}function beginDesktop(r){chrome.desktopCapture.chooseDesktopMedia(["screen","window"],function(e){if(e){console.log(e);var t={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(t,function(a){console.log(a);var o=document.createElement("video");o.setAttribute("autoplay","true"),o.addEventListener("play",function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=o.videoWidth,e.height=o.videoHeight,t.drawImage(o,0,0,e.width,e.height),(dataURL=[]).push(e.toDataURL()),console.log(dataURL),o.pause(),o.srcObject=null,a.getVideoTracks()[0].stop(),$(o).remove(),$(e).remove(),tabtitle="Desktop screenshot",type="visible",menuType="desktop",r?newTab({type:"gmail",tabId:r}):newTab()},!1),o.srcObject=a},function(e){console.log(e),alert(e)})}})}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_uid"},function(e){e&&localStorage.version!=currentversion&&refreshCookie(),localStorage.version=currentversion}),google.payments.inapp.getPurchases({parameters:{env:"prod"},success:onLicenseUpdate,failure:onLicenseUpdateFail});