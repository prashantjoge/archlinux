var getMicFrame=null,audioStream=null,cameraStream=null,tempVideo=null,MIME_TYPE="video/webm",file_name="/awesome/record.webm",isRecording=!1,isRecordingPaused=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,isPremium=!1,recordingStartTime=null;function resetData(){dataArray=new ArrayBuffer(0),audioArray=new ArrayBuffer(0)}function getPremium(){return new Promise(function(r,e){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(e){e&&"1"==e.value?r(!0):r(!1)})})}var baseUrl="https://www.awesomescreenshot.com";function refreshCookie(){$.get(baseUrl+"/promotion_ex")}function goToUpgrade(){var t="https://www.awesomescreenshot.com";chrome.cookies.get({url:t,name:"screenshot_personal_type"},function(e){if(e){if("0"==e.value)var r="/premium/upgrade"}else r="/user/login?type=record_screen";chrome.tabs.create({url:t+r})})}function getMic(r,e){window.navigator.webkitGetUserMedia({audio:{optional:[{echoCancellation:!1}]}},function(e){r(e)},function(e){})}function getStream(r){return new Promise(function(t,o){if("tab"==r)chrome.tabCapture.capture({video:!0,videoConstraints:{mandatory:{maxWidth:2560,maxHeight:1440}}},function(e){t(e)});else if("desktop"==r){var e=["screen","window"];"Mac OS"==getOS()&&e.push("audio"),chrome.desktopCapture.chooseDesktopMedia(e,function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(r,t,o)}})}})}function setBadge(e,r){"text"===e?chrome.browserAction.setBadgeText({text:r}):"color"===e&&chrome.browserAction.setBadgeBackgroundColor({color:r})}function beginRecord(o){o.isRecordMic&&getMic(function(e){audioStream=e}),getStream(o.recordType).then(function(e){if(setBadge("color","red"),0<o.countdown)var r=parseInt(o.countdown),t=setInterval(function(){setBadge("text",r+""),0==r&&(clearInterval(t),setBadge("text","REC"),gotStream(e)),r--},1e3);else gotStream(e)}).catch(function(e){console.log("[ERROE]: ",e)})}function captureTabUsingTabCapture(e){getMic(function(e){audioStream=e});screen.width,screen.height;chrome.desktopCapture.chooseDesktopMedia(["screen","window","audio"],function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(r,function(e){gotStream(e)},function(){})}})}function canvasRecord(e){var r=document.getElementById("desktop-video");r.srcObject=e,r.play();var t=document.getElementById("tempCanvas"),o=t.getContext("2d");recorder=RecordRTC(t,{type:"canvas"}),console.log(recorder),e.onended=function(){recorder&&(e.onended=function(){}),document.getElementById("awesome").postMessage({command:"stop"}),audioStream&&audioStream.stop(),recorder.stopped=!0,recorder.stopRecording(function(){var e=recorder.getBlob();console.log(e)})},e.getVideoTracks()[0].onended=function(){recorder&&e.onended()},console.log("sdf"),function e(){console.log("sdfsd"),o.drawImage(r,0,0,r.clientWidth,r.clientHeight),window.recorder&&recorder.stopped||requestAnimationFrame(e)}(),recorder.startRecording()}function handleMessage(e){console.log("[NACL]: ",e.data.name,e.data.message),"videodata"==e.data.name?appendVideoData(e.data.data):"videoend"==e.data.name&&fileSaver.save(new Blob([dataArray],{type:"video/webm"}),"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm").then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?srcUrl="+e+"&name=record.webm"})})}).catch(function(e){console.log(e)})}function appendVideoData(e){var r=new Uint8Array(dataArray.byteLength+e.byteLength);r.set(new Uint8Array(dataArray),0),r.set(new Uint8Array(e),dataArray.byteLength),dataArray=r.buffer,console.log("video: "+e.byteLength)}function gotStream2(e){resetData(),track=e.getVideoTracks()[0];var r=$("video")[0];if(r.srcObject=e,r.muted=!0,r.play(),console.log(r),audioStream)var t=audioStream.getAudioTracks()[0].getConstraints();else{t={}}var o=$("profileList"),n=o.length<1?"vp8":o.options[o.selectedIndex].value,a={};console.log({command:"start",track:track,profile:n,filename:file_name,channelCount:t.channelCount?t.channelCount:2,audioSampleRate:t.sampleRate?t.sampleRate:48e3,sampleSize:t.sampleSize?t.sampleSize:16,frameRate:a.frameRate?a.frameRate:25,width:a.width?a.width:2560,height:a.height?a.height:1440}),document.getElementById("awesome").postMessage({command:"start",track:track,profile:n,filename:file_name,width:a.width?a.width:screen.width,height:a.height?a.height:screen.height}),startDate=new Date,intervalID=setInterval(function(){var e=new Date-startDate;$("length").innerHTML="Time interval: "+e},100),e.getVideoTracks()[0].onended=function(){document.getElementById("awesome").postMessage({command:"stop"})}}function gotStream(e){var r={type:"video",disableLogs:!1,recorderType:MediaStreamRecorder};if(r.mimeType="video/webm; codecs="+"vp8".toLowerCase(),audioStream&&audioStream.getAudioTracks&&audioStream.getAudioTracks().length){audioPlayer=document.createElement("audio"),audioPlayer.srcObject=audioStream,audioPlayer.muted=!0,audioPlayer.play(),context=new AudioContext;var t=context.createGain();t.connect(context.destination),t.gain.value=0,mediaStremSource=context.createMediaStreamSource(audioStream),mediaStremSource.connect(t),mediaStremDestination=context.createMediaStreamDestination(),mediaStremSource.connect(mediaStremDestination),e.addTrack(mediaStremDestination.stream.getAudioTracks()[0])}recorder=RecordRTC(e,r);try{recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}recorder.stream=e,isRecording=!0,recorder.stream.onended=function(){recorder&&recorder.stream&&(recorder.stream.onended=function(){}),audioStream&&audioStream.stop(),cameraStream&&cameraStream.stop(),stopScreenRecording()},recorder.stream.getVideoTracks()[0].onended=function(){recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()},recordingStartTime=(new Date).getTime(),recordingTimer=setInterval(updateRecordingTime,100)}function checkTimeLength(e){31e3<=e&&getPremium().then(function(e){e||stopStream()})}function updateRecordingTime(){if(!isRecordingPaused){var e=(new Date).getTime()-recordingStartTime;pausedTime&&(e-=pausedTime),checkTimeLength(e),setBadge("text",recordingTime=secondsToTime(e))}}function secondsToTime(e){e=Math.floor(e/1e3);var r=Math.floor(e/3600),t=e%60;return t<10&&(t="0"+t),(0<r?r+":":"")+Math.floor((e-3600*r)/60)+":"+t}function setDefaults(){recorder&&recorder.stream&&(recorder.stream.stop(),recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()),recorder=null,isRecording=!1,recordingTime=recordingStartTime=null,imgIndex=0}function pauseScreenRecording(){recorder.pauseRecording(),isRecordingPaused=!0,lastPausingTime=(new Date).getTime()}function resumeScreenRecording(){recorder.resumeRecording(),isRecordingPaused=!1,pausedTime=pausedTime+(new Date).getTime()-lastPausingTime}function stopStream(){isRecordingPaused&&resumeScreenRecording(),recorder&&recorder.stream&&recorder.stream.onended()}function restoreRecording(){isRecording=!1,clearInterval(recordingTimer),pausedTime=lastPausingTime=recordingTimer=null,setBadge("text","")}function stopScreenRecording(){restoreRecording(),recorder.stopRecording(function(){saveVideo(),googleEvent("record video","record video");try{peer.close(),peer=null}catch(e){}try{audioPlayer.src=null,mediaStremDestination.disconnect(),mediaStremSource.disconnect(),context.disconnect(),context=null}catch(e){}}),timer&&clearTimeout(timer)}function getFileSize(e){var r=(e/1024).toFixed(2);return r=r<1024?r.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" KB":(r=(r/1024).toFixed(2)).toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" MB"}function saveVideo(){var r="AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-"),e=(new File([recorder.getBlob()],r+".webm",{type:"video/webm"}),recorder.getBlob()),t=bytesToSize(e.size);fileSaver.save(e,r+".webm").then(function(e){DB.save({fileUrl:e,title:r,size:t,duration:recordingTime}).then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?id="+e})}),setDefaults()})})}function googleEvent(e,r){ga&&ga("send","event","chrome extension",e,r)}function getOS(){window.navigator.userAgent;var e=window.navigator.platform,r=null;return-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(e)?r="Mac OS":-1!==["Win32","Win64","Windows","WinCE"].indexOf(e)?r="Windows":!r&&/Linux/.test(e)&&(r="Linux"),r}chrome.cookies.get({url:baseUrl,name:"screenshot_personal_type"},function(e){void 0===e&&refreshCookie()}),$(document).ready(function(){}),DB.init(),window.addEventListener("message",function(e){"audioStream"==e.data.type&&(audioStream=e.data.steam)},!1),chrome.commands.onCommand.addListener(function(e){console.log("Command:",e),"stop-recording"===e?stopStream():"pause-or-resume-recording"===e&&(isRecordingPaused?resumeScreenRecording():pauseScreenRecording())});